{% extends "base.html" %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/mypage.css' %}?v=3">
{% endblock %}

{% block content %}
    <div class="background-a"></div>
    <div class="mypage-profile">
        <!-- 제목 -->
        <div class="mypage-header">
            <h1 class="mypage-title">마이페이지</h1>
        </div>

        <!-- 유저 정보 -->
        <div class="user-info">
            <div class="user-profile">
                <div class="user_profile_img">
                    {% if user.profile_image.url != '' %}
                    <img src="{{ user.profile_image.url }}" alt="프로필 사진">
                    {% else %}
                    <img src="{% static 'images/base_user_image.png' %}" alt="기본 프로필">
                    {% endif %}
                </div>
                <!-- 프로필 수정 버튼 -->
                <label for="profile-upload" class="edit-profile-btn">
                    <img src="{% static 'images/edit_icon.png' %}" alt="프로필 수정">
                </label>
                <input type="file" id="profile-upload" class="profile-upload" accept="image/*" style="display: none;">
            </div>

            <div class="user-name-container">
                <p class="user-name" id="user-name">{{ user.nickname }}</p>
                <img src="{% static 'images/edit_icon.png' %}" alt="이름 수정" class="edit-name-btn" id="edit-name-btn">
            </div>
            <p>{{ user.email }}</p>
            <button class="add-btn" id="edit-profile-btn">
                <a href="{% url 'users:render_profile' user.pk %}">마이프로필 수정</a>
            </button>
        </div>

        <!-- 반려친구 리스트 -->
        <div class="friends-list">
            <div class="friends-list-management-header">
                <h2 class="friends-list-title">반려친구 관리</h2>
                <button class="add-btn" id="add-friends-list-btn">
                    <a href="{% url 'diaries:pet_or_plant' %}">추가</a>
                </button>
            </div>

            <div class="friends-list-list" id="friends-list-list">
                {% for f in friends %}
                <div class="friend-item" id="friend-{{ f.id }}">
                    <div class="friend-info">
                        <a href="{% url 'diaries:pet_or_plant' %}" class="friend-name">{{ f.name }}</a>
                    </div>
                    <div class="friend-actions">
                        <button class="edit-btn" onclick="editFriend({{ f.id }})">수정</button>
                        <button class="delete-btn" onclick="deleteFriend({{ f.id }})">삭제</button>
                    </div>
                </div>
                {% empty %}
                <p class="no-friends">등록된 반려친구가 없습니다.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        document.getElementById("profile-upload").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById("profile-image").src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        function editFriend(friendId) {
            window.location.href = `/diaries/edit_pet/${friendId}/`;  // 수정 페이지로 이동
        }

        function deleteFriend(friendId) {
            if (confirm("정말 삭제하시겠습니까?")) {
                fetch(`/diaries/delete_pet/${friendId}/`, {
                    method: "DELETE",
                    headers: {
                        "X-CSRFToken": getCSRFToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`friend-${friendId}`).remove();
                    } else {
                        alert("삭제 실패");
                    }
                });
            }
        }

        function getCSRFToken() {
            return document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1];
        }
    </script>
{% endblock %}