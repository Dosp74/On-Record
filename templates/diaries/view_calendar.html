{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/view_calendar.css' %}">
{% endblock %}

{% block content %}
<div class="background-a"></div>
<div class="calender-container">
    <!-- 연·월 선택 드롭다운 -->
    <div class="dropdowns">
        <select id="year-select">
            {% for y in year_range %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>
        <select id="month-select">
            {% for m in month_range %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- 캘린더 UI -->
    <table>
        <thead>
            <tr>
                <th class="day-name">일</th>
                <th class="day-name">월</th>
                <th class="day-name">화</th>
                <th class="day-name">수</th>
                <th class="day-name">목</th>
                <th class="day-name">금</th>
                <th class="day-name">토</th>
            </tr>
        </thead>
        <tbody>
            <tr>  {# 첫 번째 행 시작 #}
                {% for day in days %}
                    {% if day == 1 %}
                        <td colspan="{{ first_day }}"></td>  {# 1일 시작 요일 맞추기 #}
                    {% endif %}

                    {% with diary_count=diary_map|get_item:day %} {# diary_count 는 with 태그 안에서만 존재 #}
                        {% if total_friends > 0 %}
                            {% if diary_count == 0 %}
                                <td> {# 일기를 안 쓴 경우 색을 적용하지 않음 #}
                            {% elif diary_ratios|get_item:day == 1 %}
                                <td style="background-color: var(--diary-full); border-radius: 50%;"> {# 모든 반려친구에게 일기를 쓴 경우 #}
                            {% elif diary_count == 1 and diary_ratios|get_item:day != 1 %}
                                <td style="background-color: var(--diary-one); border-radius: 50%;">
                            {% elif diary_ratios|get_item:day < 1 %}
                                <td style="background-color: var(--diary-half); border-radius: 50%;">
                            {% else %}
                                <td> {# 그 외에는 기본 색상 #}
                            {% endif %}
                        {% else %}
                            <td> {# 총 반려친구 수가 0일 때는 기본 색상 #}
                        {% endif %}
                    
                            <a href="{% url 'diaries:friend_list' %}?day={{ day }}&month={{ month }}&year={{ year }}" class="diary-day">
                                {{ day }}
                            </a>
                        </td>
                    
                    {% endwith %}
                
                    {% if day|add:first_day|divisibleby:7 %}
                        </tr><tr>  {# 7일마다 줄 바꿈 #}
                    {% endif %}
                {% endfor %}
            </tr>
        </tbody>
    </table>
</div>

<!-- 연·월 변경 시 GET 요청 -->
<script>
    document.getElementById("year-select").addEventListener("change", function() {
        var year = this.value;
        var month = document.getElementById("month-select").value;
        window.location.href = `/calendar/${year}/${month}/`;
    });
    document.getElementById("month-select").addEventListener("change", function() {
        var year = document.getElementById("year-select").value;
        var month = this.value;
        window.location.href = `/calendar/${year}/${month}/`;
    });
    </script>

{% endblock %}
