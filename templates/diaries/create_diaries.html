{% extends 'base.html' %}
{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'css/write_diaries.css' %}">
{% endblock %}

{% block content %}
    <div class="background-a"></div>
    <div class="write-container">
        <!-- form을 여기서 시작 -->
        <form method="POST" action="{% url 'diaries:create_diaries' %}?day={{selected_date.day}}&month={{selected_date.month}}&year={{selected_date.year}}" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="write-header">
                <div class="today-diary">오늘의 일기</div>
                <div class="write-header-l">
                    <h1 id="date"></h1>
                    <button type="button" id="toggle-disclosure" class="public-btn" data-status="{{ form.disclosure.value }}">
                        {% if form.disclosure.value == True %}
                            전체공개
                        {% else %}
                            비공개
                        {% endif %}
                    </button>
                    {{ form.disclosure }}
                </div>
            </div>

            <div class="write-header-a">
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <div class="form-group">
                        <label>제목</label>
                        {{ form.title }}
                    </div>
                    <div class="write-header-a-l">
                        <div class="form-group">
                            <label>날씨</label>
                            {{ form.weather }}
                        </div>
                        <div class="form-group">
                            <label>기분</label>
                            {{ form.mood }}
                        </div>
                        <div class="form-group">
                            <label>누구에게 쓰실 건가요?</label>
                            {{ form.pet }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="diary-content">
                <div class="image-upload">
                    <label for="form-image">
                        <img id="form-preview" src="#" alt="이미지 업로드">
                    </label>
                    <input type="file" id="form-image" name="image" accept="image/*">
                    {{ form.image }}

                </div>
                <div class="text-input">
                    <label for="id_content">내용</label>
                    {{ form.content }}
                </div>
            </div>
            <button type="submit" class="create-btn">완료</button>
        </form>
    </div>

    <script>
        // ✅ URL에서 특정 파라미터 값을 가져오는 함수
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // ✅ URL에서 year, month, day 값을 가져옴
        const year = getQueryParam("year");
        const month = getQueryParam("month");
        const day = getQueryParam("day");

        // ✅ JavaScript에서 날짜를 표시하는 함수
        function formatDate() {
            // URL에서 가져온 날짜가 없으면 현재 날짜를 사용
            const today = new Date();
            const selectedYear = year || today.getFullYear();
            const selectedMonth = month || (today.getMonth() + 1); // JS에서 월은 0부터 시작하므로 +1 필요
            const selectedDay = day || today.getDate();

            // ✅ 날짜 형식 맞추기 (2자리 숫자)
            const formattedMonth = String(selectedMonth).padStart(2, '0');
            const formattedDay = String(selectedDay).padStart(2, '0');

            // ✅ 요일 계산
            const dateObj = new Date(selectedYear, selectedMonth - 1, selectedDay); // JS는 월이 0부터 시작
            const daysOfWeek = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
            const dayOfWeek = daysOfWeek[dateObj.getDay()];

            // ✅ HTML 요소에 날짜 출력
            document.getElementById("date").textContent = `${selectedYear}/${formattedMonth}/${formattedDay} ${dayOfWeek}`;
        }


        document.addEventListener("DOMContentLoaded", function () {
            formatDate();
            const toggleBtn = document.getElementById("toggle-disclosure");
            const disclosureField = document.getElementById("id_disclosure");
        
            toggleBtn.addEventListener("click", function () {
                let currentStatus = toggleBtn.getAttribute("data-status") === "True";
                let newStatus = !currentStatus; 
        
                toggleBtn.textContent = newStatus ? "비공개" : "전체공개";
                disclosureField.checked = newStatus; 
                disclosureField.value = newStatus ? "true" : "false"; 
                toggleBtn.setAttribute("data-status", newStatus);
            });
        });

        document.getElementById("form-image").addEventListener("change", function(event) {
            var input = event.target;
            var reader = new FileReader();
    
            reader.onload = function() {
                var imgElement = document.getElementById("form-preview");
                imgElement.src = reader.result;  // 선택한 이미지를 미리보기로 설정
                imgElement.style.display = "block"; // 이미지 표시
            };
    
            if (input.files && input.files[0]) {
                reader.readAsDataURL(input.files[0]);  // 파일을 읽어서 미리보기로 설정
            }
        });
    </script>
{% endblock %}
